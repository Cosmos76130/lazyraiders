<!DOCTYPE html>
<html>
<head>
    <title>Lazyraiders</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <h1>Lazyraiders - v1.1.1</h1>
    <table>
        <thead>
            <tr>
                <th>character</th>
                <th>item level</th>
                <th>tier piece(s)</th>
                <th>key</th>
                <th>run date</th>
            </tr>
        </thead>
        <tbody id="raiderio-data">
        </tbody>
    </table>

    <script>
fetch('players.txt')
    .then(response => response.text())
    .then(text => {
        const players = text.trim().split('\n');
        console.log('Players:', players);
        const promises = players.map(player => {
            const [name, realm] = player.split('-');
            const url = `https://raider.io/api/v1/characters/profile?region=tw&realm=${realm}&name=${name}&fields=mythic_plus_recent_runs,gear&_=${new Date().getTime()}`;

            return fetch(url)
                .then(response => response.json())
                .then(json => {
                    console.log(`完整 API 回應 for ${name}:`, json);

                    const run = json.mythic_plus_recent_runs?.[0] || null; // 只抓最近 1 場

                    const gear = json.gear;
                    if (!gear) {
                        console.warn(`Gear is undefined for ${name}`);
                        return null;
                    }

                    return {
                        name,
                        ilvl: gear?.item_level_equipped ? Math.round(gear.item_level_equipped) : 'n/a',
                        key: run ? run.mythic_level : 'n/a',
                        time: run ? new Date(run.completed_at).toLocaleString() : 'n/a'
                    };
                })
                .catch(error => {
                    console.error('Error fetching data for player:', name, error);
                    return null;
                });
        });

        Promise.all(promises).then(results => {
            console.log('Results:', results);
            const validResults = results.filter(result => result !== null);
            const sortedResults = validResults.sort((a, b) => (a.ilvl !== 'n/a' ? a.ilvl : Infinity) - (b.ilvl !== 'n/a' ? b.ilvl : Infinity));
            const tbody = document.getElementById('raiderio-data');

            sortedResults.forEach(result => {
                const tr = document.createElement('tr');

                const nameTd = document.createElement('td');
                nameTd.textContent = result.name;
                tr.appendChild(nameTd);

                const ilvlTd = document.createElement('td');
                ilvlTd.textContent = result.ilvl;
                tr.appendChild(ilvlTd);

                const keyTd = document.createElement('td');
                keyTd.textContent = result.key;
                tr.appendChild(keyTd);

                const timeTd = document.createElement('td');
                timeTd.textContent = result.time;
                tr.appendChild(timeTd);

                tbody.appendChild(tr);
            });
        }).catch(error => {
            console.error('Error resolving promises:', error);
        });
    })
    .catch(error => {
        console.error('Error fetching players.txt:', error);
    });
    </script>
</body>
</html>
